{% extends "base.html" %}
{% block title %}Assign Projects{% endblock %}

{% block head_extra %}
<style>
  .footer {
  margin-top: 20px;       /* table ku gap */
  padding: 15px 0;
  text-align: center;
  font-size: 14px;
  color: #fff;

  /* background: rgba(255,255,255,0.1); 
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-top: 1px solid rgba(255,255,255,0.25);*/
}
  .wrap-card { max-width: 1100px; margin: 10px auto; background:#2b2f36; border-radius:16px;
               box-shadow:0 12px 28px rgba(0,0,0,.35); border:1px solid #1f2329; padding:18px 18px 10px; }
  .wrap-head { background:#3a3f46; border-radius:12px 12px 0 0; padding:14px 18px; font-weight:700; color:#fff; border:1px solid #2c3137; }
  .wrap-body { padding:16px 12px 8px; }
  .form-row { display:flex; gap:14px; flex-wrap:wrap; align-items:end; padding:2px 8px; }
  .fg { min-width:260px; flex:1 1 300px; }
  label { color:#e8e8e8; margin-bottom:6px; font-weight:600; }
  select, input[type="text"] { background:#121519; color:#eaeaea; border:1px solid #444; padding:10px 12px; border-radius:8px; width:100%; }
  .btn-yellow { background:#ffd24d; color:#111; font-weight:700; border:none; padding:4px 8px; border-radius:8px; transition:.25s; }
  .btn-yellow:hover { background:#f7c933; transform: translateY(-1px); }
  .btn-ghost  { border:1px solid #aaa; color:#f5f5f5; background:transparent; padding:4px 8px; border-radius:8px; transition:.25s; }
  .btn-ghost:hover { background:#2b2b2b; border-color:#ccc; transform: scale(1.02); }
  .btn-end-now { background:#e74c3c; color:#fff; border:none; padding:8px 14px; border-radius:8px; transition:.25s; }
  .btn-end-now:hover { background:#c0392b; transform: scale(1.03); }
  .pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; margin-left:8px; background:#444; color:#fff; }
  .pill-assigned { background:#27ae60; color:#111; }
  .u-table { width:100%; border-collapse:separate; border-spacing:0; }
  .u-table thead th { background:#ffd24d; color:#111; font-weight:500; padding:4px 8px;font-size:15px;text-align: left; }
  .u-table tbody td { background:#333940; color:#eaeaea;font-size:13px; padding:2px 12px; border-top:1px solid #2a2f35; }
  .u-table tbody tr:nth-child(even) td { background:#2f353c; }
  .u-table tbody tr:hover td { background:#293039; }
  .toolbar { display:flex; align-items:center; gap:10px; justify-content:space-between; margin:10px 0 6px; }
  .muted { color:#c9c9c9; }
</style>
{% endblock %}

{% block content %}

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
  <a href="{{ url_for('dashboard') }}" class="btn-ghost" style="text-decoration:none;">← Home</a>
  <div style="display:flex; gap:10px;">
    <a href="{{ url_for('user_access') }}" class="btn-yellow" style="text-decoration:none;">Assigned Projects - User</a>
    <a href="{{ url_for('admin_project_codes') }}" class="btn-yellow" style="text-decoration:none;">Project Allocations</a>
    <a href="{{ url_for('live_status') }}" class="btn-yellow" style="text-decoration:none;">live status</a>
  </div>
</div>



  <div class="wrap-head">Assign Users to a Project Code</div>
  <div class="wrap-body">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-2">
          {% for cat, msg in messages %}
            <div class="alert alert-{{ 'success' if cat=='success' else ('danger' if cat=='error' else 'info') }} mb-2">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Project first -->
    <div class="form-row">
      <div class="fg">
        <label>Project Code</label>
        <select id="projectSelect">
          <option value="" disabled selected>Select Code</option>
          {% for c in codes if c.status == 'WIP' %}
        <option value="{{ c.id }}">{{ c.code }}{% if c.team %} — {{ c.team }}{% endif %}</option>
        {% endfor %}

        </select>
      </div>

      <div class="fg">
        <label>Quick Filter (user)</label>
        <input type="text" id="userFilter" placeholder="Type to filter users by name/team…">
      </div>

      <div class="fg" style="flex:0 0 auto; display:flex; gap:10px;">
        <button id="assignBtn" class="btn-yellow" disabled>Assign</button>
        <button id="endBtn" class="btn-ghost" disabled>Unassign</button>
      </div>
    </div>

    <!-- Users table with checkboxes -->
    <form id="bulkForm" method="post" class="mt-2">
      <input type="hidden" name="project_id" id="projectHidden">
      <input type="hidden" name="action" id="actionHidden">
      <div class="toolbar">
        <div>
          <label><input type="checkbox" id="checkAll" disabled> Select All</label>
          <span class="pill" id="selCount">0 selected</span>
          <span class="pill" id="assignedCount">0 already assigned</span>
        </div>
        <div class="muted">Tip: choose a project first, then select users and click Assign / End.</div>
      </div>

      <div class="table-responsive">
        <table class="u-table">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th style="width:60px;">Pick</th>
              <th>User</th>
              <th>Team</th>
              <th>Assigned?</th>
            </tr>
          </thead>
          <tbody id="userRows">
            {% for u in users %}
            <tr data-username="{{ u.username|lower }}" data-team="{{ (u.team or '')|lower }}">
              <td>{{ loop.index }}</td>
              <td>
                <input type="checkbox" class="u-check" name="user_ids" value="{{ u.id }}" disabled>
              </td>
              <td>{{ u.username }}</td>
              <td>{{ u.team or '' }}</td>
              <td class="assign-cell">
                <span class="pill">—</span>
              </td>
            </tr>
            {% endfor %}
            {% if not users %}
            <tr><td colspan="5" class="muted" style="text-align:center; padding:14px;">No users found.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </form>
  </div>

  <!-- Existing active assignments table (kept) -->
  <div class="wrap-head" style="border-top:0; border-radius:0;">Active Assignments</div>
  <div class="wrap-body" style="padding-top:8px;">
    <div class="table-responsive">
      <table class="u-table">
        <thead>
          <tr>
            <th style="width:70px;">#</th>
            <th>User</th>
            <th>Project Code</th>
            <th>Status</th>
            <th>Assigned By</th>
            <th>Start Date</th>
          </tr>
        </thead>
        <tbody>
          {% for a in active %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ a.user.username }}</td>
            <td>{{ a.project.code }}</td>
            <td><span class="pill pill-assigned">{{ a.project.status }}</span></td>
            <td>{{ a.assigned_by.username if a.assigned_by else '' }}</td>
            <td>{{ a.start_date.strftime('%Y-%m-%d') if a.start_date else '' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="muted" style="text-align:center; padding:18px;">No active assignments.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="footer">
  <p>© Datasolve Analytics Pvt Ltd 2025.</p>
</footer>
<script>
  // Data from backend: map of project_id -> [user_id, ...] who are currently assigned (active)
  const assignedMap = {{ assigned_map|tojson }};  // e.g., {"12":[3,7], "13":[5]}
  const projectSelect = document.getElementById('projectSelect');
  const userRows = document.getElementById('userRows');
  const checkAll = document.getElementById('checkAll');
  const selCount = document.getElementById('selCount');
  const assignedCount = document.getElementById('assignedCount');
  const assignBtn = document.getElementById('assignBtn');
  const endBtn = document.getElementById('endBtn');
  const bulkForm = document.getElementById('bulkForm');
  const projectHidden = document.getElementById('projectHidden');
  const actionHidden = document.getElementById('actionHidden');
  const userFilter = document.getElementById('userFilter');

  function updateCounts() {
    const checks = userRows.querySelectorAll('.u-check:not([disabled])');
    const selected = Array.from(checks).filter(c => c.checked).length;
    selCount.textContent = selected + ' selected';
    assignBtn.disabled = selected === 0 || !projectSelect.value;
    endBtn.disabled = selected === 0 || !projectSelect.value;
  }

  function renderAssignmentBadges() {
    const pid = projectSelect.value;
    const assignedSet = new Set((assignedMap[pid] || []).map(String));
    let assignedTotal = 0;

    userRows.querySelectorAll('tr').forEach(tr => {
      const cb = tr.querySelector('.u-check');
      const uid = cb ? cb.value : null;
      const cell = tr.querySelector('.assign-cell');
      if (!cb || !cell) return;

      // Enable the checkbox only when project selected
      cb.disabled = !pid;

      // Mark assigned state
      if (pid && uid && assignedSet.has(uid)) {
        cell.innerHTML = '<span class="pill pill-assigned">Assigned</span>';
        assignedTotal++;
      } else {
        cell.innerHTML = '<span class="pill">—</span>';
      }
    });

    assignedCount.textContent = assignedTotal + ' already assigned';
    checkAll.checked = false;
    checkAll.disabled = !pid;
    updateCounts();
  }

  projectSelect.addEventListener('change', () => {
    projectHidden.value = projectSelect.value || '';
    // Clear selections on change
    userRows.querySelectorAll('.u-check').forEach(cb => { cb.checked = false; });
    renderAssignmentBadges();
  });

  checkAll.addEventListener('change', () => {
    const pid = projectSelect.value;
    const assignedSet = new Set((assignedMap[pid] || []).map(String));
    userRows.querySelectorAll('.u-check:not([disabled])').forEach(cb => {
      // Select all (even if already assigned) so user can bulk end too
      cb.checked = checkAll.checked;
    });
    updateCounts();
  });

  userRows.addEventListener('change', (e) => {
    if (e.target.classList.contains('u-check')) updateCounts();
  });

  userFilter.addEventListener('input', () => {
    const q = userFilter.value.trim().toLowerCase();
    userRows.querySelectorAll('tr').forEach(tr => {
      const u = tr.getAttribute('data-username') || '';
      const t = tr.getAttribute('data-team') || '';
      tr.style.display = (u.includes(q) || t.includes(q)) ? '' : 'none';
    });
  });

  assignBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!projectSelect.value) return;
    actionHidden.value = 'bulk_assign';
    bulkForm.submit();
  });

  endBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!projectSelect.value) return;
    actionHidden.value = 'bulk_end';
    bulkForm.submit();
  });

  // Initial
  renderAssignmentBadges();
</script>
{% endblock %}

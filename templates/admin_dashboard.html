{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<style>
    :root {
        --brand: #ffd24d;
        --bg: #0f151d;
        --card-bg: #1c2530;
        --highlight: #3498db;
        --shadow-light: rgba(255, 255, 255, 0.05);
    }
    body {
        background: var(--bg);
        color: #fff;
        font-family: 'Inter', sans-serif;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Tighter grid for more data */
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,.3);
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s, border 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border: 1px solid transparent;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,.5), 0 0 0 1px var(--highlight);
        border: 1px solid var(--highlight);
    }
    .card h2 {
        font-size: 30px; /* Slightly smaller for better fit */
        font-weight: 800;
        margin-bottom: 5px;
        color: var(--brand);
    }
    .card p {
        font-size: 14px;
        color: #ccc;
        margin: 0;
        font-weight: 500;
    }
    .chart-card {
        min-height: 320px;
        box-shadow: 0 4px 12px rgba(0,0,0,.3);
        padding: 20px;
    }
    @media (min-width: 1024px) {
        .wide-chart {
            grid-column: span 2;
        }
    }
    .filters-form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        background: var(--card-bg);
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .table-wrap {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 20px;
        margin-top: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,.3);
    }
    .table {
        width: 100%; border-collapse: collapse; font-size: 14px;
    }
    .table th, .table td {
        padding: 12px; border-bottom: 1px solid #2e3845; text-align: left; /* Darker line */
    }
    .table th {
        background: linear-gradient(90deg, #ffd24d, #ffecae);
        color: #111; font-weight: 700; text-transform: uppercase;
    }
    /* Modal styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85); z-index: 1000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: var(--card-bg); color: #fff;
        padding: 30px; border-radius: 16px; width: 90%; max-width: 900px; /* Wider modal */
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; border-bottom: 1px solid var(--highlight); padding-bottom: 10px;
    }
    .modal-close {
        font-size: 24px; font-weight: bold; cursor: pointer; color: #ccc;
        transition: color 0.2s;
    }
    .modal-close:hover { color: var(--brand); }
</style>

<div class="dashboard-grid">
    <div class="card" data-title="Total Entries" data-body="Total entries for selected criteria.">
        <h2>{{ total_entries }}</h2>
        <p>Total Entries</p>
    </div>
    <div class="card" data-title="Active Users" data-body="Users who have logged time with the current filters.">
        <h2>{{ total_users }}</h2>
        <p>Active Users</p>
    </div>
    <div class="card" data-title="Total Work Hours" data-body="Total productive hours logged, excluding breaks. Decimal Value: {{ total_work_hours }}">
        <h2>{{ total_work_hours | hm_format }}</h2>
        <p>Total Work Hours</p>
    </div>
    <div class="card" data-title="Total Break Hours" data-body="Total time logged under the 'Breaks' process. Decimal Value: {{ total_break_hours }}">
        <h2>{{ total_break_hours | hm_format }}</h2>
        <p>Total Break Hours</p>
    </div>
    
    <!-- Active Projects Card (Now shows list in modal) -->
    <div class="card" data-title="Active Project Codes" data-body="Projects with recorded entries in the current filter period.">
        <h2>{{ active_project_codes|length }}</h2>
        <p>Active Projects</p>

        <div class="mt-4 text-xs text-left px-2 py-2 bg-background max-h-28 overflow-y-auto rounded-lg border border-gray-700 flex-grow">
            <p class="font-semibold text-brand-green mb-1">Project Codes ({{ active_project_codes|length }})</p>
            <ul id="project-list-summary" class="space-y-0.5 list-disc list-inside text-gray-400">
                {% for code in active_project_codes %}
                <li>{{ code }}</li>
                {% else %}
                <li>No projects found.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
</div>

<form method="POST" class="filters-form">
    <!-- User Dropdown Filtering -->
    <div class="flex items-center gap-2">
        <label for="start_date" class="text-gray-300">Start Date:</label>
        <input type="date" id="start_date" name="start_date" class="bg-background border border-gray-600 rounded-lg p-2 text-white text-sm focus:border-brand" value="{{ start_date if start_date }}">
    </div>
    <div class="flex items-center gap-2">
        <label for="end_date" class="text-gray-300">End Date:</label>
        <input type="date" id="end_date" name="end_date" class="bg-background border border-gray-600 rounded-lg p-2 text-white text-sm focus:border-brand" value="{{ end_date if end_date }}">
    </div>
    <div class="flex items-center gap-2">
        <label for="user_select" class="text-gray-300">Select User:</label>
        <select name="user_select" id="user_select" class="bg-background border border-gray-600 rounded-lg p-2 text-white text-sm focus:border-brand">
            <!-- Superadmin will see this option. Admin will not, as Python filters the list. -->
            {% if current_user.role == 'superadmin' %}
            <option value="all" {% if selected_user == 'all' or selected_user == None %}selected{% endif %}>All Users (Superadmin)</option>
            {% endif %}
            
            {% for user in users %}
            <option value="{{ user }}" {% if selected_user == user %}selected{% endif %}>{{ user }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="bg-highlight text-white px-4 py-2 rounded-lg hover:bg-opacity-80 transition duration-150">Apply Filters</button>
</form>

<div class="dashboard-grid mt-8">
    <!-- Charts Grid (Adjusted layout) -->

    <div class="card chart-card wide-chart"><canvas id="dailyWorkBreakChart"></canvas></div>
    <div class="card chart-card wide-chart"><canvas id="userHoursChart"></canvas></div>

    <div class="card chart-card"><canvas id="processChart"></canvas></div>
    <div class="card chart-card"><canvas id="subProcessChart"></canvas></div>
    <div class="card chart-card wide-chart"><canvas id="projectHoursChart"></canvas></div>
</div>

<div class="table-wrap">
    <h3 class="text-xl font-semibold mb-4 text-gray-200">Recent Logs ({{ table_data|length }} entries)</h3>
    <div class="overflow-x-auto rounded-lg">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Project</th>
                    <th>Process</th>
                    <th>Sub-Process</th>
                    <th>Duration (HH:MM)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in table_data %}
                <tr class="hover:bg-gray-700 transition duration-100">
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                    <td>{{ row[2] }}</td>
                    <td>{{ row[3] }}</td>
                    <td>{{ row[4] }}</td>
                    <td>{{ row[5] | hm_format }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Overlay -->
<div id="infoModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalTitle" class="text-2xl font-bold text-brand"></h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <p id="modalBody" class="text-gray-300"></p>
        <div id="modalDetails" class="mt-4 text-sm text-gray-400 border-t border-gray-700 pt-3"></div>
    </div>
</div>


<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Attach click listener to cards
        document.querySelectorAll('.card').forEach(card => {
            if (card.hasAttribute('data-title')) {
                card.addEventListener('click', () => {
                    const title = card.getAttribute('data-title');
                    const body = card.getAttribute('data-body');
                    openModal(title, body);
                });
            }
        });
    });

    // Utility function for Modal
    function openModal(title, body) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').textContent = body;
        document.getElementById('modalDetails').innerHTML = ''; // Clear previous details

        if (title.includes('Active Projects')) {
            const listHtml = document.getElementById('project-list-summary').innerHTML;
            document.getElementById('modalDetails').innerHTML = `
                <p class="font-semibold text-white mb-2 mt-2">All {{ active_project_codes|length }} Project Codes:</p>
                <div class="bg-background p-3 rounded-lg max-h-60 overflow-y-auto">
                    ${listHtml}
                </div>
            `;
        }
        
        document.getElementById('infoModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('infoModal').style.display = 'none';
    }

    // --- Chart Data Initialization ---
    
    // Process Chart
    const processChart = new Chart(document.getElementById("processChart"), {
        type: "bar",
        data: {
            labels: {{ process_data|map(attribute=0)|list|tojson }},
            datasets: [{
                label: "Entries Count",
                data: {{ process_data|map(attribute=1)|list|tojson }},
                backgroundColor: "var(--brand)"
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Process Breakdown (Entries)', color: '#ccc' },
                legend: { display: false }
            }
        }
    });
    
    // Daily Work Break Chart
    const dailyWorkBreakChart = new Chart(document.getElementById("dailyWorkBreakChart"), {
        type: "line",
        data: {
            labels: {{ daily_work_break_data|map(attribute=0)|list|tojson }},
            datasets: [{
                label: "Work Hours",
                data: {{ daily_work_break_data|map(attribute=1)|list|tojson }},
                borderColor: "#2ecc71",
                fill: false, tension: 0.3
            }, {
                label: "Break Hours",
                data: {{ daily_work_break_data|map(attribute=2)|list|tojson }},
                borderColor: "#e74c3c",
                fill: false, tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Daily Work vs. Break Hours', color: '#ccc' }
            }
        }
    });

    // Top User Hours Chart
    const userHoursChart = new Chart(document.getElementById("userHoursChart"), {
        type: "bar",
        data: {
            labels: {{ user_hours|map(attribute=0)|list|tojson }},
            datasets: [{
                label: "Hours",
                data: {{ user_hours|map(attribute=1)|list|tojson }},
                backgroundColor: "var(--highlight)"
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bars
            responsive: true,
            plugins: {
                title: { display: true, text: 'Top User Hours', color: '#ccc' },
                legend: { display: false }
            }
        }
    });
    
    // Sub-Process Chart
    const subProcessChart = new Chart(document.getElementById("subProcessChart"), {
        type: "pie",
        data: {
            labels: {{ sub_process_data|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ sub_process_data|map(attribute=1)|list|tojson }},
                backgroundColor: ["#3498db", "#ffd24d", "#9b59b6", "#1abc9c", "#f39c12"]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Sub-Process Distribution', color: '#ccc' }
            }
        }
    });

    // Project Hours Chart
    const projectHoursChart = new Chart(document.getElementById("projectHoursChart"), {
        type: "bar",
        data: {
            labels: {{ project_hours_data|map(attribute=0)|list|tojson }},
            datasets: [{
                label: "Total Hours",
                data: {{ project_hours_data|map(attribute=1)|list|tojson }},
                backgroundColor: "#2ecc71"
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bars
            responsive: true,
            plugins: {
                title: { display: true, text: 'Project-wise Hours', color: '#ccc' }
            }
        }
    });
</script>
{% endblock %}
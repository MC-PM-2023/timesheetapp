{% extends "base.html" %}
{% block title %}Project Codes{% endblock %}

{% block head_extra %}
<style>
  .footer {
    margin-top: 20px;       /* table ku gap */
    padding: 15px 0;
    text-align: center;
    font-size: 14px;
    color: #fff;
    /* background: rgba(255,255,255,0.1); 
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    border-top: 1px solid rgba(255,255,255,0.25);*/
  }
  .fg-inline {
    display: flex;
    justify-content: center;  /* horizontal center */
    align-items: flex-end;    /* align bottom */
    gap: 12px;                /* space between dropdown and button */
    margin-top: 12px;
  }

  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --panel: #1b2330;
    --text: #e6edf3;
    --muted: #9fb0c6;
    --line: #2b3442;
    --brand: #ffd24d;
    --brand-d: #f2c844;
    --good: #19c37d;
    --warn: #f59e0b;
    --hold: #8b5cf6;
    --closed: #ef4444;
  }

  /* Page Base */
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, sans-serif;
  }

  /* Card Shell */
  .wrap-card {
    max-width: 2180px;
    margin: 16px auto 24px;
    background: linear-gradient(180deg, #1a2130, #151b27);
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, .45);
    border: 1px solid #222a36;
    overflow: hidden;
  }

  /* Top Bar */
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
  }
  .top-bar .btn-yellow { margin-left: 14px; }

  /* Button Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 700;
    text-decoration: none;
    transition: transform .08s ease, background .2s ease, border-color .2s;
    border: 1px solid transparent;
    line-height: 1;
    cursor: pointer;
  }
  .btn:active { transform: translateY(1px); }
  .btn-ghost {
    background: transparent;
    color: #eaeaea;
    border-color: #3a4454;
  }
  .btn-ghost:hover {
    background: #202838;
    border-color: #4a5568;
  }
  .btn-yellow {
    background: #ff944d;
    border: none;
    padding: 12px 28px;   /* bigger height + width */
    font-size: 16px;      /* text size bigger */
    font-weight: 600;     /* bold */
    border-radius: 8px;   /* rounded */
    cursor: pointer;
    transition: 0.2s;
    color: #111;
  }
  .btn-yellow:hover { background: #f2c844; }

  /* Section Headers */
  .wrap-head {
    background:
      radial-gradient(1200px 200px at 20% -10%, rgba(255, 210, 77, .08), transparent 60%),
      linear-gradient(180deg, #202738 0%, #1a2130 100%);
    border-top: 1px solid var(--line);
    border-bottom: 1px solid var(--line);
    padding: 14px 18px;
    font-weight: 800;
    letter-spacing: .2px;
  }

  .wrap-body { padding: 18px 16px; }

  /* Form Grid */
  .form-grid {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    align-items: end;
  }
  .fg { min-width: 240px; flex: 1 1 280px; }
  label {
    color: #e8e8e8;
    margin-bottom: 6px;
    display: inline-block;
    font-weight: 700;
  }
  input, select {
    width: 100%;
    background: #0f1420;
    color: var(--text);
    border: 1px solid #2b3442;
    border-radius: 10px;
    padding: 11px 12px;
    outline: none;
    transition: border-color .2s, box-shadow .2s;
  }
  input:focus, select:focus {
    border-color: #5b6b84;
    box-shadow: 0 0 0 3px rgba(91, 107, 132, .2);
  }

  /* Alerts */
  .alert {
    border-radius: 10px;
    padding: 10px 12px;
    margin: 6px 0;
    font-weight: 600;
  }
  .alert-success { background: #0f2a1f; border: 1px solid #1f6b4d; color: #bff3db; }
  .alert-danger  { background: #2a1111; border: 1px solid #6b1f1f; color: #f3c0c0; }
  .alert-info    { background: #0f1a2a; border: 1px solid #1f3e6b; color: #c0d9f3; }

  /* Table Shell */
  .tbl-box { background: var(--surface); border-top: 1px solid var(--line); }
  .table-wrap { max-height: 60vh; overflow: auto; }
  table { width: 100%; border-collapse: separate; border-spacing: 0; }

  /* Table Head */
  thead th {
    position: sticky;
    top: 0;
    z-index: 3;
    background: linear-gradient(180deg, #ffe175, #ffd24d);
    color: #0b0b0b;
    font-weight: 900;
    padding: 12px 14px;
    text-align: left;
    border-bottom: 2px solid #d9b93f;
  }
  thead tr.filters-row th {
    position: sticky;
    top: 48px;
    z-index: 3;
    background: #111723;
    border-bottom: 1px solid #263045;
    padding: 6px 8px;
  }
  .filters-row .fsel {
    width: 100%;
    padding: 8px 10px;
    font-weight: 700;
    border: 1px solid #404a60;
    border-radius: 8px;
    background: #0e1a2a;
    color: #dfe8f5;
  }

  /* Table Body */
  tbody td {
    padding: 12px 14px;
    border-top: 1px solid #20283a;
    background: #1a2130;
  }
  tbody tr:nth-child(even) td { background: #171e2b; }
  tbody tr:hover td { background: #152035; }

  /* Index Cell */
  .col-idx { width: 72px; color: #cbd5e1; }

  /* Status Select */
  .status-select {
    appearance: none;
    padding-right: 36px;
    font-weight: 800;
    text-transform: uppercase;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23cbd5e1' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
  }
  .status-select,
  .status-select option {
    background-color: #0f1420 !important;
    color: #e6edf3 !important;
  }
  .status-select:focus {
    background-color: #0f1420 !important;
    border-color: #5b6b84;
    outline: none;
  }
  .status-select[data-status="WIP"],
  .status-select[value="WIP"] {
    background-color: rgba(25,195,125,.08);
    border-color: #2a7257;
  }
  .status-select[data-status="YTI"],
  .status-select[value="YTI"] {
    background-color: rgba(245,158,11,.10);
    border-color: #8a6a1f;
  }
  .status-select[data-status="Hold"],
  .status-select[value="Hold"] {
    background-color: rgba(139,92,246,.10);
    border-color: #5b4ab4;
  }
  .status-select[data-status="Closed"],
  .status-select[value="Closed"] {
    background-color: rgba(239,68,68,.10);
    border-color: #903a3a;
  }

  /* Search Box */
  .srch {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    background: #0f1420;
    border: 1px solid #2b3442;
    border-radius: 10px;
    padding: 8px 10px;
  }
  .srch input {
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    width: 220px;
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    right: 16px;
    bottom: 16px;
    background: #0b1320;
    color: #e9f1ff;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #2b3b55;
    box-shadow: 0 10px 26px rgba(0, 0, 0, .5);
    opacity: 0;
    transform: translateY(10px);
    transition: all .25s ease;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* ==== COMPACT OVERRIDES ==== */
  /* Form: shrink fields + labels */
  .form-grid { gap: 10px; }
  .fg { min-width: 180px; flex: 1 1 200px; }
  label { font-size: 12.5px; margin-bottom: 4px; }

  /* Inputs & selects smaller */
  input, select {
    padding: 8px 10px;     /* ↓ height */
    font-size: 13px;       /* ↓ text size */
    border-radius: 8px;    /* slightly tighter */
  }

  /* Status dropdown smaller */
  .status-select {
    padding: 6px 26px 6px 10px;  /* left/right tuned for caret space */
    font-size: 12.5px;
  }

  /* Table: compact head + body */
  #codesTable thead th {
    padding: 8px 10px;     /* ↓ head cell height */
    font-size: 13px;
  }
  /* raise the sticky filters row closer to the header */
#codesTable thead tr.filters-row th {
  top: 34px;        /* was 48px; move it up */
  padding: 3px 6px; /* a touch tighter */
  border-top: none; /* removes any hairline gap */
}

/* keep header compact so the 34px offset matches neatly */
#codesTable thead th {
  padding: 8px 10px;
}

/* tighter selects so the row can sit higher without crowding */
#codesTable .filters-row .fsel {
  padding: 4px 8px;     /* a bit shorter */
  font-size: 12px;
  line-height: 1.1;
  min-height: 26px;
  border-radius: 6px;
}


  /* Body rows smaller */
  #codesTable tbody td {
    padding: 2px 4px;     /* ↓ row height */
    line-height: 1.2;      /* tighter line height */
    font-size: 13px;
  }

  /* Index col narrower */
  #codesTable .col-idx { width: 56px; }

  /* Tighter paddings */
  .table-wrap { max-height: 60vh; }
  .wrap-body { padding: 14px 12px; }
</style>
{% endblock %}

{% block content %}
<div class="wrap-card">

  <div class="top-bar">
    <a href="{{ url_for('dashboard') }}" class="btn btn-ghost">← Home</a>
    <a href="{{ url_for('assign_projects') }}" class="btn btn-yellow">› Assign a Project</a>
  </div>

  <div class="wrap-head">Create / Update Project Code</div>
  <div class="wrap-body">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-2">
          {% for cat, msg in messages %}
            <div class="alert alert-{{ 'success' if cat=='success' else ('danger' if cat=='error' else 'info') }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="post" class="form-grid" autocomplete="off" id="codeForm">
      <div class="fg">
        <label>Project</label>
        <input type="text" id="project" name="project" placeholder="e.g., project code" required>
      </div>

      <div class="fg">
        <label>Project Type</label>
        <input type="text" id="ptype" name="ptype" placeholder="e.g., Type of Project" required>
      </div>

      {% if team not in ["IPTeam","MRTeam","BDTeam","AnalyticsTeam"] %}
      <div class="fg">
        <label>Country</label>
        <input type="text" id="country" name="country" placeholder="e.g., US">
      </div>

      <div class="fg">
        <label>Disease</label>
        <input type="text" id="disease" name="disease" placeholder="e.g., Cancer">
      </div>
      {% endif %}

      <div class="fg">
        <label>Project Code</label>
        <input type="text" id="code" name="code" readonly>
      </div>

      <div class="fg-inline" style="width:100%;">
        <div class="fg" style="max-width:260px;">
          <label>Status</label>
          <select name="status" class="status-select">
            <option value="WIP" selected>WIP</option>
            <option value="YTI">YTI</option>
            <option value="Hold">Hold</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        <div class="fg" style="flex:0 0 auto; max-width:200px;">
          <label style="opacity:0; user-select:none;">Save</label>
          <button class="btn btn-yellow" type="submit">Save</button>
        </div>
      </div>
    </form>
  </div>

  <div class="wrap-head" style="border-radius:0;">Existing Codes</div>
  <div class="tbl-box">
    <div class="table-wrap">
      <table id="codesTable">
        <thead>
          <tr>
            <th style="width:72px;">#</th>
            <th>Code</th>
            <th>Status</th>
            <th>Team</th>
            <th>Start Date</th>
            <th>End / Hold Date</th>
            <th>YTI → WIP (End)</th>
          </tr>
          <tr class="filters-row">
            <th><select data-col="0" class="fsel"><option value="">All</option></select></th>
            <th><select data-col="1" class="fsel"><option value="">All</option></select></th>
            <th>
              <select data-col="2" class="fsel">
                <option value="">All</option>
                <option>WIP</option>
                <option>YTI</option>
                <option>Hold</option>
                <option>Closed</option>
              </select>
            </th>
            <th><select data-col="3" class="fsel"><option value="">All</option></select></th>
            <th><select data-col="4" class="fsel"><option value="">All</option></select></th>
            <th>
              <div style="display:flex; gap:8px; align-items:center;">
                <select data-col="5" class="fsel"><option value="">All</option></select>
                <button type="button" id="resetFilters" class="btn btn-ghost" style="padding:6px 10px;">Reset</button>
              </div>
            </th>
            <th><select data-col="6" class="fsel"><option value="">All</option></select></th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
          <tr data-id="{{ r.id }}">
            <td class="col-idx">{{ loop.index }}</td>

            <!-- Project Code forced uppercase in display -->
            <td class="col-code">{{ r.code if r.code else '' }}</td>

            <td class="col-status">
              <select class="status-select" data-status="{{ r.status }}">
                <option value="WIP"   {{ 'selected' if r.status=='WIP'   else '' }}>WIP</option>
                <option value="YTI"   {{ 'selected' if r.status=='YTI'   else '' }}>YTI</option>
                <option value="Hold"  {{ 'selected' if r.status=='Hold'  else '' }}>Hold</option>
                <option value="Closed"{{ 'selected' if r.status=='Closed'else '' }}>Closed</option>
              </select>
            </td>

            <td class="col-team">{{ r.team or '' }}</td>
            <td class="col-start">{{ r.start_date.strftime('%Y-%m-%d') if r.start_date else '' }}</td>
            <td class="col-endhold">
              {% if r.status == 'Closed' and r.end_date %}
                {{ r.end_date.strftime('%Y-%m-%d') }}
              {% elif r.status == 'Hold' and r.hold_on %}
                Hold on {{ r.hold_on.strftime('%Y-%m-%d') }}
              {% endif %}
            </td>
            <td class="col-ytiend">{{ r.yti_end_date.strftime('%Y-%m-%d') if r.yti_end_date else '' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" style="text-align:center; color:#c9c9c9; padding:20px;">No project codes yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Footer -->
  <footer class="footer">
    <p>© Datasolve Analytics Pvt Ltd 2025.</p>
  </footer>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  /* ===================== TABLE HANDLING ===================== */
  const table = document.getElementById('codesTable');
  const tbody = table.querySelector('tbody');
  const filterSelects = table.querySelectorAll('.filters-row .fsel');
  const quickSearch = document.getElementById('quickSearch'); // optional

  const STATUS_RANK = { "WIP":1, "YTI":2, "Hold":3, "Closed":4 };
  const rank = s => STATUS_RANK[s] || 999;

  const showToast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1600);
  };

  const parseEndHold = (rowData) => {
    if (rowData.status === 'Closed' && rowData.end_date) return rowData.end_date;
    if (rowData.status === 'Hold'   && rowData.hold_on)  return 'Hold on ' + rowData.hold_on;
    return '';
  };

  function getStatus(tr){
    const sel = tr.querySelector('.status-select');
    return sel ? sel.value : (tr.querySelector('.col-status')?.textContent?.trim() || "");
  }

  /* === Inline Status Change === */
  tbody.addEventListener('change', async (e) => {
    if (!e.target.classList.contains('status-select')) return;
    const select = e.target;
    const tr = select.closest('tr');
    const theId = tr.dataset.id;
    const newStatus = select.value;

    select.setAttribute('data-status', newStatus); // for CSS

    try {
      const res = await fetch('{{ url_for("update_project_status") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: theId, status: newStatus })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.message || 'Update failed');

      tr.querySelector('.col-start').textContent   = data.start_date || '';
      tr.querySelector('.col-endhold').textContent = parseEndHold(data);
      tr.querySelector('.col-ytiend').textContent  = data.yti_end_date || '';

      sortByStatusThenCode();
      buildDropdowns();
      applyFilters();
      if (quickSearch) quickFilter();
      showToast('Status updated ✓');
    } catch (err) {
      console.error(err);
      showToast('Update failed');
    }
  });

  /* === Filters Helpers === */
  function cellText(tr, idx){
    if (idx === 2) {
      const sel = tr.querySelector('.status-select');
      return sel ? sel.value : (tr.cells[idx].textContent || '').trim();
    }
    return (tr.cells[idx].textContent || '').trim();
  }

  function uniqSort(arr){
    return Array.from(new Set(arr.filter(Boolean)))
                .sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
  }

  function buildDropdowns(){
    const cols = [[],[],[],[],[],[],[]];
    Array.from(tbody.rows).forEach(tr=>{
      [0,1,2,3,4,5,6].forEach(i=> cols[i].push(cellText(tr,i)));
    });

    filterSelects.forEach(sel=>{
      const col = parseInt(sel.dataset.col,10);
      const current = sel.value;
      sel.innerHTML = '<option value="">All</option>';
      if (col !== 0) {
        uniqSort(cols[col]).forEach(v=>{
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
      }
      if ([...sel.options].some(o=>o.value===current)) sel.value = current;
    });
  }

  function applyFilters(){
    const filters = Array.from(filterSelects).reduce((a,el)=>{ a[el.dataset.col]=el.value; return a; }, {});
    Array.from(tbody.rows).forEach(tr=>{
      let visible = true;
      for (const [k,val] of Object.entries(filters)){
        if (!val) continue;
        const idx = parseInt(k,10);
        if (cellText(tr, idx) !== val) { visible = false; break; }
      }
      tr.dataset.filt = visible ? '1' : '0';
      tr.style.display = visible ? '' : 'none';
    });
    reindexVisible();
  }
  filterSelects.forEach(s=> s.addEventListener('change', ()=>{ applyFilters(); if(quickSearch) quickFilter(); }));
  document.getElementById('resetFilters').addEventListener('click', ()=>{
    filterSelects.forEach(s=> s.value='');
    applyFilters();
    if (quickSearch) quickFilter();
  });

  /* === Sorting === */
  function sortByStatusThenCode(){
    const rows = Array.from(tbody.rows);
    rows.sort((a,b)=>{
      const sa = getStatus(a), sb = getStatus(b);
      const ra = rank(sa), rb = rank(sb);
      if (ra !== rb) return ra - rb;
      const ca = a.querySelector('.col-code')?.textContent?.trim() || '';
      const cb = b.querySelector('.col-code')?.textContent?.trim() || '';
      return ca.localeCompare(cb, undefined, { numeric:true, sensitivity:'base' });
    });
    rows.forEach(r => tbody.appendChild(r));
    reindexVisible();
  }

  function reindexVisible(){
    let i=1;
    Array.from(tbody.rows).forEach(tr=>{
      if (tr.style.display!=='none'){
        tr.querySelector('.col-idx').textContent = i++;
      }
    });
  }

  /* === Quick Search === */
  function quickFilter(){
    if (!quickSearch) return;
    const q = (quickSearch.value || '').toLowerCase().trim();
    Array.from(tbody.rows).forEach(tr=>{
      const passesFilters = tr.dataset.filt !== '0';
      if (!passesFilters){ tr.style.display='none'; return; }
      if (!q){ tr.style.display=''; return; }
      const txt = [
        tr.querySelector('.col-code')?.textContent || '',
        tr.querySelector('.col-team')?.textContent || '',
        tr.querySelector('.col-start')?.textContent || '',
        tr.querySelector('.col-endhold')?.textContent || '',
        tr.querySelector('.col-ytiend')?.textContent || '',
        getStatus(tr) || ''
      ].join(' ').toLowerCase();
      tr.style.display = txt.includes(q) ? '' : 'none';
    });
    reindexVisible();
  }
  if (quickSearch) quickSearch.addEventListener('input', quickFilter);

  /* === Init === */
  tbody.querySelectorAll('.status-select').forEach(s=> s.setAttribute('data-status', s.value));
  sortByStatusThenCode();
  buildDropdowns();
  applyFilters();
  if (quickSearch) quickFilter();

  /* ===================== PROJECT CODE AUTO-FILL ===================== */
  const project = document.getElementById("project");
  const ptype   = document.getElementById("ptype");
  const country = document.getElementById("country");  // may be null
  const disease = document.getElementById("disease");  // may be null
  const code    = document.getElementById("code");

  // team is injected from Flask backend
  const team = "{{ team|default('', true) }}";
  const disableTeams = ["IPTeam","MRTeam","BDTeam","AnalyticsTeam"];

  // If fields exist and team is in disableTeams → clear & disable them
  if (disableTeams.includes(team)) {
    if (country) { country.value = ""; country.disabled = true; }
    if (disease) { disease.value = ""; disease.disabled = true; }
  }

  function buildCode() {
    const proj = project.value.trim();
    const pt   = ptype.value.trim();
    const ct   = country ? country.value.trim() : "";
    const ds   = disease ? disease.value.trim() : "";

    let finalCode = "";
    if (team === "MCTeam") {
      if (proj && pt && ct && ds) finalCode = `${proj}_${pt}_${ct}_${ds}`;
    } else if (disableTeams.includes(team)) {
      if (proj && pt) finalCode = `${proj}_${pt}`;
    } else {
      if (proj && pt) finalCode = `${proj}_${pt}${ct ? "_" + ct : ""}${ds ? "_" + ds : ""}`;
    }
    code.value = finalCode;
  }

  [project, ptype].forEach(el => el.addEventListener("input", buildCode));
  if (country) country.addEventListener("input", buildCode);
  if (disease) disease.addEventListener("input", buildCode);
});
</script>
{% endblock %}
